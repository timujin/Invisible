[gd_scene load_steps=5 format=2]

[ext_resource path="res://Assets/Player.png" type="Texture" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends KinematicBody2D

signal reached_destination

var path = null
var speed = 100 setget set_path

# Called when the node enters the scene tree for the first time.
func _ready():
	var nav  = get_tree().get_root().get_node(\"Base/Navigation2D\")
	#var goal = get_tree().get_root().get_node(\"Base/Goal\")
	#path = nav.get_simple_path(global_position, goal.global_position)
	
func set_destination(destination:Node2D):
	var nav = get_tree().get_root().get_node(\"Base/Navigation2D\")
	var goal = destination.global_position
	path = nav.get_simple_path(self.global_position, goal, false)
	get_tree().get_root().get_node(\"Base/Line2D\").points = path
	
	
func is_walking():
	return path != null
	
func _process(delta):
	#set_destination(get_tree().get_nodes_in_group(\"player\")[0])
	if path == null:
		return
	move_along_path(delta * speed)
		
func set_path(value):
	path = value
	if path.size() == 0:
		path = null
		
func move_along_path(distance):
	if position.distance_to(path[path.size()-1]) <= 10:
		print(\"rch\")
		emit_signal(\"reached_destination\")
		path = null
		return
		
	var start_position := position
	for i in range(path.size()):
		var distance_to_next = start_position.distance_to(path[0])
		if distance <= distance_to_next and distance >= 0.0:
			position = start_position.linear_interpolate(path[0], distance/ distance_to_next)
			break
		elif distance <= 0:
			position = path[0]
			path = null
			return
		distance -= distance_to_next
		start_position = path[0]
		path.remove(0)
		"

[sub_resource type="CircleShape2D" id=2]
radius = 16.5683

[sub_resource type="GDScript" id=3]
script/source = "extends Node

enum State { PATROL, LOOKAROUND, HUNT }

var current_state

var patrol_target : Node2D = null

onready var enemy : KinematicBody = get_node(\"..\")

func _ready():
	call_deferred(\"start_patrol\")

func start_patrol():
	var destinations = get_tree().get_nodes_in_group(\"patrol_points\")
	randomize()
	var destination = destinations[randi() % destinations.size()]
	enemy.set_destination(destination)
	current_state = State.PATROL
	
var lookaround_timeout = 0
func start_looking_around():
	lookaround_timeout = 3.0
	current_state = State.LOOKAROUND
	
	
func _process(delta):
	if current_state == State.PATROL:
		pass
	elif current_state == State.LOOKAROUND:
		lookaround_timeout -= delta
		if lookaround_timeout <= 0:
			start_patrol()
	elif current_state == State.HUNT:
		pass
	

func _on_Enemy_reached_destination():
	start_looking_around()
	
"

[node name="Enemy" type="KinematicBody2D"]
collision_layer = 3
collision_mask = 3
script = SubResource( 1 )

[node name="Sprite" type="Sprite" parent="."]
modulate = Color( 1, 0, 0, 1 )
rotation = 1.5708
scale = Vector2( 0.18, 0.18 )
texture = ExtResource( 1 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2( -5.19653, 0.225941 )
rotation = 0.804494
shape = SubResource( 2 )

[node name="AI" type="Node" parent="."]
script = SubResource( 3 )
[connection signal="reached_destination" from="." to="AI" method="_on_Enemy_reached_destination"]
