[gd_scene load_steps=8 format=2]

[ext_resource path="res://Assets/Player.png" type="Texture" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends KinematicBody2D

signal reached_destination

var path = null
var speed = 100 setget set_path

# Called when the node enters the scene tree for the first time.
func _ready():
	var nav  = get_tree().get_root().get_node(\"Base/Navigation2D\")
	#var goal = get_tree().get_root().get_node(\"Base/Goal\")
	#path = nav.get_simple_path(global_position, goal.global_position)
	
func set_destination(destination:Node2D):
	var nav = get_tree().get_root().get_node(\"Base/Navigation2D\")
	var goal = destination.global_position
	path = nav.get_simple_path(self.global_position, goal, false)
	#get_tree().get_root().get_node(\"Base/Line2D\").points = path
	
	
func is_walking():
	return path != null
	
func _process(delta):
	#set_destination(get_tree().get_nodes_in_group(\"player\")[0])
	if path == null:
		return
	move_along_path(delta * speed)
		
func set_path(value):
	path = value
	if path.size() == 0:
		path = null
		
func move_along_path(distance):
	if position.distance_to(path[path.size()-1]) <= 10:
		print(\"rch\")
		emit_signal(\"reached_destination\")
		path = null
		return
		
	var start_position := position
	look_at(path[0])
	for i in range(path.size()):
		var distance_to_next = start_position.distance_to(path[0])
		if distance <= distance_to_next and distance >= 0.0:
			position = start_position.linear_interpolate(path[0], distance/ distance_to_next)
			break
		elif distance <= 0:
			position = path[0]
			path = null
			return
		distance -= distance_to_next
		start_position = path[0]
		path.remove(0)
		
func kill():
	queue_free()"

[sub_resource type="CircleShape2D" id=2]
radius = 16.5683

[sub_resource type="GDScript" id=3]
script/source = "extends Node

enum State { PATROL, LOOKAROUND, HUNT }

var current_state

onready var enemy : KinematicBody = get_node(\"..\")

func _ready():
	call_deferred(\"start_patrol\")


var patrol_target : Node2D = null
func start_patrol():
	var destinations = get_tree().get_nodes_in_group(\"patrol_points\")
	randomize()
	var destination = destinations[randi() % destinations.size()]
	enemy.set_destination(destination)
	current_state = State.PATROL
	
var lookaround_timeout = 0
func start_looking_around():
	lookaround_timeout = 2.0
	current_state = State.LOOKAROUND
	$\"../AnimationPlayer\".play(\"LookAround\")
	
var last_known_player_location = Vector2(0,0)
func notice_player(location):
	last_known_player_location = location
	enemy.set_destination(location)
	current_state = State.HUNT
	
func _process(delta):
	if current_state == State.PATROL:
		pass
	elif current_state == State.LOOKAROUND:
		lookaround_timeout -= delta
		if lookaround_timeout <= 0:
			start_patrol()
	elif current_state == State.HUNT:
		pass
	

func _on_Enemy_reached_destination():
	start_looking_around()
	


func _on_Raycasts_player_detected():
	notice_player(get_tree().get_nodes_in_group(\"player\")[0])
"

[sub_resource type="GDScript" id=4]
script/source = "extends Area2D

func _process(delta):
	var player = get_tree().get_nodes_in_group(\"player\")[0]
	if overlaps_body(player):
		player.kill()
		return
		
	for door in get_tree().get_nodes_in_group(\"doors\"):
		if overlaps_body(door):
			door.open()"

[sub_resource type="GDScript" id=5]
script/source = "extends Node2D

signal player_detected

var i = 0
func _process(delta):
	i+=1
	for ray in get_children():
		if not ray.is_colliding(): continue
		var collider = ray.get_collider()
		if collider.is_in_group(\"player\"):
			#print (\"DETECTED\" + str(i))
			emit_signal(\"player_detected\")
			return"

[sub_resource type="Animation" id=6]
resource_name = "LookAround"
length = 2.0
tracks/0/type = "value"
tracks/0/path = NodePath(".:rotation_degrees")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0, 1.9 ),
"transitions": PoolRealArray( 1, 1 ),
"update": 0,
"values": [ 0.0, 1080.0 ]
}

[node name="Enemy" type="KinematicBody2D"]
rotation = 18.8496
collision_layer = 3
collision_mask = 3
script = SubResource( 1 )

[node name="Sprite" type="Sprite" parent="."]
modulate = Color( 1, 0, 0, 1 )
rotation = 1.5708
scale = Vector2( 0.18, 0.18 )
texture = ExtResource( 1 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
position = Vector2( -5.19653, 0.225941 )
rotation = 0.804494
shape = SubResource( 2 )

[node name="AI" type="Node" parent="."]
script = SubResource( 3 )

[node name="KillArea" type="Area2D" parent="."]
monitorable = false
script = SubResource( 4 )

[node name="Node2D" type="CollisionPolygon2D" parent="KillArea"]
position = Vector2( 0.244181, 0.244163 )
polygon = PoolVector2Array( -7.46675, -21.9326, 25.6509, -16.6582, 24.4316, 17.4041, -8.07948, 23.249 )

[node name="Raycasts" type="Node2D" parent="."]
editor/display_folded = true
visible = false
script = SubResource( 5 )

[node name="RayCast2D" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, 0 )
collision_mask = 3

[node name="RayCast2D2" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, 50 )
collision_mask = 3

[node name="RayCast2D10" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, 100 )
collision_mask = 3

[node name="RayCast2D11" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, -100 )
collision_mask = 3

[node name="RayCast2D12" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, -80 )
collision_mask = 3

[node name="RayCast2D13" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, 80 )
collision_mask = 3

[node name="RayCast2D14" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, 70 )
collision_mask = 3

[node name="RayCast2D15" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, -70 )
collision_mask = 3

[node name="RayCast2D8" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, 40 )
collision_mask = 3

[node name="RayCast2D9" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, -40 )
collision_mask = 3

[node name="RayCast2D3" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, -50 )
collision_mask = 3

[node name="RayCast2D4" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, -25 )
collision_mask = 3

[node name="RayCast2D5" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, 25 )
collision_mask = 3

[node name="RayCast2D6" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, 12 )
collision_mask = 3

[node name="RayCast2D7" type="RayCast2D" parent="Raycasts"]
enabled = true
cast_to = Vector2( 500, -12 )
collision_mask = 3

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
anims/LookAround = SubResource( 6 )
[connection signal="reached_destination" from="." to="AI" method="_on_Enemy_reached_destination"]
[connection signal="player_detected" from="Raycasts" to="AI" method="_on_Raycasts_player_detected"]
